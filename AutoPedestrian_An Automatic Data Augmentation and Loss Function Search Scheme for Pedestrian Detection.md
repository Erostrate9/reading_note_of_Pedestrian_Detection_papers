# AutoPedestrian_An Automatic Data Augmentation and Loss Function Search Scheme for Pedestrian Detection

## 1. Introduction

行人检测已经在视频监控、机器人导航、人员识别、自动驾驶等方面有了广泛的应用。近年来，随着深度学习和卷积神经网络（CNN）的发展，行人检测领域取得了许多令人瞩目的进展。在行人检测方面取得了令人瞩目的进展。

然而，考虑到实际环境中的不同挑战，如遮挡、尺度变化大、光照度差等，行人检测仍有很大的改进空间。对于大多数深度学习相关的方法来说，克服上述挑战的一个常见方法是数据增强，这在深度学习中已经流行了几年，因为它可以有效地扩大训练数据集，并大大提高模型的通用能力。一些通用的图像数据增强操作，如ﬂip、scale、rotation、crop、cutout和mixup，已经在许多图像处理和计算机视觉问题中被使用。

对于行人检测，有研究采用一些数据增强操作，如随机调整大小裁剪、亮度调整和一些模拟遮挡，以改进性能。然而，如何将这些操作组合起来，并设置每个操作的参数，需要丰富的经验和巨大的努力。此外，由于行人的特殊性和独特性，一些操作可能不适合行人检测的应用场景，例如，旋转在大多数情况下不适合行人检测，因为行人的姿态在图像中往往是垂直地面的。因此，找到不同操作的有效增强组合是非常重要的，这就是数据增强策略（data augmentation policy）。为行人检测自动找到有效的数据增强策略仍未得到充分探索。因此，该研究打算找到一种合适的基于CNN的行人检测器数据增强策略，以缓解上述行人检测中常见的问题。

此外，损失函数在机器学习中十分重要，一般来说，为不同的问题设计特定的损失函数需要大量的人类专业知识，其相关的超参数调整极为耗时。为了解决这些问题，作者设计了一个用于行人检测的遗传损失函数。具体来说，作者应用不同的超参数来表示不同的损失函数。

模型表现很大程度上取决于多任务学习问题的合适权重设计。对于行人检测，分类和回归这两个任务可以被认为是一个特定的多任务问题。因此，作者也考虑到损失权重，并以有效的方式自动搜索最佳损失函数组合为目标。

数据增强和损失函数还有一些协同效应。例如，当通过增强生成更多遮挡样本（难分样本）时，可能会加剧难分样本和简单样本之间的不平衡。这个问题的一个直接的解决方案是调整难分和简单示例的损失权重或设计一个特定的损失函数。因此，作者认为数据增强和损失函数的联合搜索方式可以产生更好的行人检测结果。

为了同时找到最优的数据增强策略和损失函数，作者提出了一种能够有效地自动搜索它们的AutoPedestrian方案。特别地，作者提出了用于行人检测的数据增强和损失函数的搜索空间，然后将数据增强策略和损失函数策略建模为具有不同超参数的两个分布。

研究的目标是搜索各自的最优超参数。为了解决这个问题，作者提出了一种双循环方案。内循环通过联合采样数据增强操作和损失函数来最小化检测网络的损失，而外循环最大化关于数据增强和损失函数分布的回报。同时，具有最佳模型的参数将被同步广播到每个并行模型。对于外循环优化，一个常见的解决方案是应用强化学习，通过策略梯度估计来优化相关的超参数。然而，常见的强化方法可能存在采样效率低和训练过程不稳定的问题。因此，作者使用重要性采样来调整更新规则以适应非策略学习，从而缓解上述问题。作者在两个基准数据集CityPersons和CrowdHuman上广泛测试了我们提出的方案的性能，验证了其优越的行人检测性能。

### 工作贡献

1. 提出了第一个框架 自动搜索数据增强和损失函数的联合最佳策略，用于行人检测。
2. 根据作者提出的搜索空间，将数据增强策略和损失函数策略作为两个具有不同超参数的分布，然后提出一个带有重要性抽样的AutoPedestrian方案来有效地解决优化问题，得到最佳的数据增强策略和损失函数。
3. 在CrowdHuman数据集上取得了40.58% MR；并且在没有引入额外的可见注释时，在CityPersons的合理子集上取得了11.3%的MR，这是这两个数据集上新的最先进结果。全面的消融研究也表明了该方法的有效性。

## 2. 相关工作

### 行人检测

目标检测领域已取得了显著进展。大多数行人检测方法都是基于一般的目标检测，但在人群场景中检测被遮挡的行人仍然具有挑战性。现在解决的常用方法是part-based方法，该方法设计了一系列基于身体部分的检测器来处理遮挡实例。此外，一些工作还利用新的损失函数处理拥挤场景中的行人检测。与以往相关工作不同，本文作者打算在一个框架内通过自动数据增强和损失搜索来进一步克服遮挡问题。

### Data Augmentation

典型的数据增强操作包括ﬂip、scale、rotation、crop等，并被广泛用于增加数据集的大小和提高网络的通用性。
然而，要为不同的计算机视觉任务找到一个合适的数据增强策略并不容易。随着神经结构搜索（NAS）和自动机器学习（Auto ML）的出现，一些自动数据增强方法被提出来解决这个问题。例如References [16], [40] 将一个循环神经网络（RNN）作为控制器来找到最佳的数据增强策略。[42]提出了一种高效的贝叶斯超参数优化与密度匹配来加快搜索过程。对于行人检测中的数据增强，[43]利用一种基于渲染的重塑方法来生成大量的合成训练样本。与[43]类似，[44]也旨在通过GAN从3D游戏引擎中生成合成训练样本。然而，合成行人和真实行人之间的差距可能对检测器构成负面影响。为了解决这个问题，[45]提出了一个基于形状变换的框架来获得更真实的行人。与这些方法不同，作者专注于为行人检测寻找合适的增强策略和损失函数，为基于CNN的行人检测算法产生更好的组件。据作者所知，为行人检测自动识别一个合适的数据增强策略以前没有得到很好的研究，这也是这项工作的重点之一。

### 损失函数

对于目标检测，边界盒回归损失（bounding box regression loss）在目标定位中起着重要作用。常用的边界盒回归损失函数有SmoothL1损失、IoU损失、GIoU损失等。至于损失权重，已经有一些研究为多任务学习寻找合适的损失权重[22]。然而，为每个任务设计损失函数和相应的损失权重通常非常耗时，需要大量的人力资源。最近提出了一些自动损失函数搜索方法[25]，[46]，它们利用增强学习在统一的搜索空间中搜索合适的参数，但搜索空间是为分类任务设计的，如人员识别和人脸识别。与这些方法相比，本研究搜索专门为行人检测设计的不同损失函数的可能组合，从而获得可能更好的检测性能。

## 3. Methods

图1:![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215000007.png)

### 问题表述

假设有一个检测器模型$M_w$，将其参数化为$w$，训练集和验证集表示为$\mathcal{D}_{tr}=\{(x_i,y_i)\}^n_{i=1}和D_{val}$，数据增强策略$\mathcal{O}_\theta$被参数化为$\theta$，损失函数$\mathcal{L}_\varphi$被参数化为$\varphi$。因此，目标函数被定义为调整$\theta和\varphi$来最大化模型$M_w$的回报$R(M_w;\mathcal{D}_{val})$，表示为：

$\theta,\varphi=arg \max\limits_{\theta,\varphi}R(M_{w^*};\mathcal{D}_{})$

$s.t. w^*=arg\min\limits_{w}\sum\limits_{(x,y)\in\mathcal{D_{tr}}}\mathcal{L}_\varphi(M_w(\mathcal{O}_\theta(x),y)).$

如果将整个模型的权重$w$和超参数$\theta,\varphi$作为两个优化目标，则可将其视为标准的双层优化问题，为了解决这个问题，作者提出了一个双环优化框架，使用$I$个训练步骤而不是整个训练方案来近似内环解$w^*$，并优化外环中的超参数$\theta和\varphi$.

行人检测的通用评估标准是对数平均误检率（MR）比上每张图像的假阳性（FPPI），这个值越低越好，为了使更好的回报能产生相应更低的MR，回报被表示为：$R(M_w;\mathcal{D}_{val})=1-MR(M_W;\mathcal{D}_{val})$

### 数据增强的搜索空间

#### 遮挡模拟增强

为了更准确地划分一个人，作者以头部边界框为参考，设计了左上身、右上身、左腿、右腿的分割方式，对应0~3的索引值，对人体各部分进行分割后，按索引提取一个部分，用每张图像的平均值进行遮挡，在文章中称之为平均值遮挡增强（mean value occlusion augmentation）

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215084355.png)

作者还设计了类内遮挡增强和类间遮挡增强两种数据增强操作。如图3所示，对于类内增强，先随机选择两个地面真实边界框A和B，按先前提到的索引将绿色框a粘贴到B中的蓝色框b，对于类间遮挡增强也是类似的，不过是从非行人的背景区域中提取遮挡物（橙色框中的紫色框d粘贴到粉色框c）。

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215084527.png)

#### 图像强度和色彩增强

#### 几何操作增强

包括flip、位移、剪切等操作，但是不包括旋转，因为行人大多是脚朝下，垂直于地面。

####  数据增强搜索空间的参数化

研究中使用的数据增强操作共有114种，但对于每张图像，只选用其中2个可能的操作，操作可以重复。故对于每张图像有$114^2=12996$种可能的增强。每种操作$p_\theta(O_i)$的概率是一个关于$\theta_i$的归一化sigmoid函数

### 损失函数的搜索空间

基于深度学习的目标检测的损失函数通常包括两部分，分类损失函数（classification loss functions）和边界框回归损失（bounding box regression loss）。最终研究的损失函数策略通过一些高斯分布来参数化$$\varphi_k\sim\mathcal{N}(\mu_k,\sigma^2)$$，在双环方案中，通过优化高斯分布的均值$\mu_k$来搜索最佳损失函数。

### 优化过程

内环优化：$w^{j+1}_T=w^j_T-\beta\grad_w\mathcal{L}^T(O^T(x_B),y_B)$

外环优化：$\theta_{T+1}=\theta_T+\eta_\theta\grad_\theta R(\theta_T)=\theta_T+\eta_\theta\grad_\theta\mathbb{E}_{\mathcal{T}\sim\pi_\theta}[R(\mathcal{T})]$

整个优化流程描述为算法1:![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215092152.png)

## 4. Experiments

### 选用的数据集

CrowdMan： CrowdMan数据集[28]是一个基准数据集，用于验证行人检测器在人群场景中的性能，每张图像中平均有22.6人。它分为训练（15,000张图像）、验证（4,370张图像）和测试（5,000张图像）子集。作业评估了全身检测方法。模型在训练集上进行训练，并在验证集上进行评估。

CityPersons：CityPersons数据集[27]是一个行人检测数据集，具有全身和可见身体的高质量边界框注释。它由5，000个图像组成，其中2，975个用于训练，500个用于验证，1，525个用于测试。我们在全身检测上评估了我们提出的方法。根据可见度比率将验证集分为合理（R）子集和重度遮挡（HO）子集[6]。合理子集的可见度大于65%，严重遮挡子集的可见度范围为20%~65%。我们的模型是在合理的训练子集上训练的。我们对城市人的所有结果都是在R和HO子集中报告的。

3）Caltech：Caltech数据集[52]是一个流行的行人检测数据集。它由11组视频序列组成，前6组用于训练，后5组用于测试。作者以10Hz对训练视频序列帧进行采样，以1Hz对测试视频序列帧进行采样。有42782个图像用于训练，4024个图像用于测试。类似于CityPersons[27]，根据能见度比率将测试集分为合理（R）子集和重度遮挡（HO）子集。

4）此外作者还在HiEve数据集上做了测试。

5）评估标准：主要是MR（越低越好），此外平均查准率（AP）和查全率（越高越好）也被用于综合评价。对于HiEve数据集，额外引入了Jaccard指数（Ji）来评估预测与真实情况的吻合程度，Ji越高性能越好。

表1通过消融研究展示了各组件提高CrowdHuman数据集性能的影响，其中AA是自动增强，ALF是自动损失函数。

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215101048.png)

表2展示了不同搜索空间对基线在CrowdHuman数据集上性能的影响，其中OSASS指遮挡模拟增强搜索空间，CLSS指分类损失搜索空间，RLSS指回归损失搜索空间。

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215101354.png)

表7,8,9分别展示了其在CityPersons, Caltech, HiEve数据集上的性能表现

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215101900.png)

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215101915.png)

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215101930.png)

下图直观展示了AutoPedestrian的识别情况，上面两行是其他尖端识别器的识别结果，蓝框是漏选项，最后一行绿框是AutoPedestrian的识别结果，在这三个测试例中AutoPedestrian没有遗漏。

![](https://raw.githubusercontent.com/Erostrate9/img/main/20211215102059.png)

## 5. Conclusion

拥挤场景中的行人检测是一项尚未解决的具有挑战性的任务。为了克服这个问题，本文利用Auto ML原理来自动搜索适合行人检测的数据增强策略和损失函数策略。相应策略的选择被建模为具有不同超参数的分布。作者精心设计了这些超参数的合适搜索空间，然后给出了基于重要性采样的双循环方案的求解过程。在CrowdHuman和CityPersons这两个基准数据集上进行的广泛消融研究和比较测试表明了所提出的AutoPedestrian方法的有效性，在这两个数据集上产生了新的最先进的结果。